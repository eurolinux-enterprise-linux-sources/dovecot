
# HG changeset patch
# User Timo Sirainen <tss@iki.fi>
# Date 1305116222 -10800
# Node ID cef76cf2cec9f2a527d50ea89b2ca1478c195d25
# Parent  8f605efb15ced8a46ae71255955566cc72e44f41
message header parser: Fixed handling NUL characters in header names.
line->name_len was too large and line->middle pointer may have pointed past
allocated memory.  These may have caused crashes/corruption (fts, mbox at
least).

--- a/src/lib-mail/message-header-parser.c	Wed May 11 14:35:15 2011 +0300
+++ b/src/lib-mail/message-header-parser.c	Wed May 11 15:17:02 2011 +0300
@@ -311,7 +311,9 @@
 			colon_pos--;
 
 		str_truncate(ctx->name, 0);
-		str_append_n(ctx->name, msg, colon_pos);
+		/* use buffer_append() so the name won't be truncated if there
+		   are NULs. */
+		buffer_append(ctx->name, msg, colon_pos);
 		str_append_c(ctx->name, '\0');
 
 		/* keep middle stored also in ctx->name so it's available

