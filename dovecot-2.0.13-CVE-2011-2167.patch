# HG changeset patch
# User Timo Sirainen <tss@iki.fi>
# Date 1307116467 -10800
# Node ID a2d57b43ccb2b7492c75dc7b3e58f57de5a434bd
# Parent  5b03ca65f4ed3259da06577e5a5aed24fe2886e8
script-login: When not using "-d" parameter, don't do unnecessary config lookup.

diff -r 5b03ca65f4ed -r a2d57b43ccb2 src/util/script-login.c
--- a/src/util/script-login.c	Fri Jun 03 18:11:00 2011 +0300
+++ b/src/util/script-login.c	Fri Jun 03 18:54:27 2011 +0300
@@ -114,13 +114,13 @@
 	master_service_init_log(master_service,
 		t_strdup_printf("script-login(%s): ", input.username));
 
-	service_ctx = mail_storage_service_init(master_service, NULL, flags);
-	if (mail_storage_service_lookup(service_ctx, &input, &user, &error) <= 0)
-		i_fatal("%s", error);
-	mail_storage_service_restrict_setenv(service_ctx, user);
-
-	if (drop_to_userdb_privileges)
+	if (drop_to_userdb_privileges) {
+		service_ctx = mail_storage_service_init(master_service, NULL, flags);
+		if (mail_storage_service_lookup(service_ctx, &input, &user, &error) <= 0)
+			i_fatal("%s", error);
+		mail_storage_service_restrict_setenv(service_ctx, user);
 		restrict_access_by_env(getenv("HOME"), TRUE);
+	}
 
 	if (dup2(fd, STDIN_FILENO) < 0)
 		i_fatal("dup2() failed: %m");


